> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [zhuanlan.zhihu.com](https://zhuanlan.zhihu.com/p/623698129)

前言
--

STM32 微控制器内置最多四个高级 12 位 ADC（取决于器件）。提供自校准功能，用于提高环境条件变化时的 ADC 精度。 在涉及模数转换的应用中，ADC 精度会影响整体的系统质量和效率。为了提高此精度，必须了解与 ADC 相关的误差以及影响它们的参数。 ADC 精度不仅取决于 ADC 性能和功能，还取决于 ADC 周围的整体应用设计。 此应用笔记旨在帮助用户了解 ADC 误差，并解释如何提高 ADC 精度。它分为三个主要部分：

• ADC 内部结构的简述，帮助用户了解 ADC 操作和相关的 ADC 参数

• 解释与 ADC 设计和外部 ADC 参数（例如外部硬件设计）有关的 ADC 误差的不同类型和来源

• 关于如何使这些误差最小化的建议，侧重于硬件和软件方法

ADC 内部原理
--------

### SAR ADC 内部结构

STM32 微控制器中内置的 ADC 使用 SAR（逐次逼近）原则，分多步执行转换。转换步骤数等 于 ADC 转换器中的位数。每个步骤均由 ADC 时钟驱动。每个 ADC 时钟从结果到输出产生一 位。ADC 的内部设计基于切换电容技术。

下面的图（图 1 至图 6）介绍了 ADC 的工作原理。下面的示例仅显示了逼近的前面几步，但 是该过程会持续到 LSB 为止。

![](https://pic3.zhimg.com/v2-e8ede15c4bf0cd403c2dd00b04cef55e_r.jpg)![](https://pic1.zhimg.com/v2-f154ecc0946f483e31826f44c8670558_r.jpg)![](https://pic3.zhimg.com/v2-e61c0173130feaa42b5701877ab5faba_r.jpg)![](https://pic2.zhimg.com/v2-dc04142c6df6d267e107e3300e76a5e9_r.jpg)![](https://pic3.zhimg.com/v2-c33e4544fd136dfc03caef053db636b6_r.jpg)![](https://pic4.zhimg.com/v2-6dd7ec01a16ed5c06423aab69d880cb3_r.jpg)

### ADC 误差

本节列出了影响模数转换精度的主要误差。这些类型的误差存在于所有模数转换器中，转换 质量将取决于它们的消除情况。STM32 微控制器数据手册的 ADC 特性部分规定了这些误差 值。

规定了 STM32 ADC 的不同精度误差类型。为便于参考，将精度误差表达为 1 LSB 的倍数。就 电压而言，分辨率取决于参考电压。通过将 LSB 数乘以 1 LSB 对应的电压来计算电压误差 （1 LSB = VREF+/2 的 12 次方或 VDDA/2 的 12 次方）。

### ADC 自身导致的误差

**偏移误差**

偏移误差是第一次实际转换和第一次理想转换之间的偏离。第一次转换发生在数字 ADC 输出从 0 变为 1 时。理想情况下，当模拟输入介于 0.5 LSB 和 1.5 LSB 之间时，数字输出应为 1。 仍然是理想情况下，第一次转换发生在 0.5 LSB 处。用 EO 表示偏移误差。可通过应用固件轻松校准偏移误差。

**示例**

对于 STM32 ADC，电压的最小可检测增量变化用 LSB 表示为：

1 LSB = VREF+/4096（在某些封装上，VREF+ = VDDA）。

如果 VREF+ = 3.3 V，则在理想情况下， 402.8 µV （0.5 LSB = 0.5 × 805.6 µV）的输入应导 致生成数字输出 1。但实际上， ADC 可能仍然提供读数 0。如果从 550 µV 的模拟输入获得 数字输出 1，

则： 偏移误差 = 实际转换 – 理想转换

EO = 550 µV – 402.8 µV = 141.2 µV

EO = 141.2 µV / 805.6 µV = 0.17 LSB

当大于 0.5 LSB 的模拟输入电压生成第一次转换时，偏移误差为正（请参见图 7 查看正偏移 误差的示例）。

![](https://pic2.zhimg.com/v2-40721cda6a643e1e327dbf7c754ba77d_r.jpg)

当小于 0.5 LSB 的模拟输入电压生成第一次转换时，偏移误差为负（请参见图 8 查看负偏移误差的示例）。

如果模拟输入电压（VAIN）等于 VSSA 并且 ADC 生成非零数字输出，则偏移误差为负。这意味 着负电压生成第一次转换。

![](https://pic4.zhimg.com/v2-371f8aec7509eed6cd4099dee1383df3_r.jpg)

**增益误差**

增益误差是最后一次实际转换和最后一次理想转换之间的偏离。增益误差用 EG 表示。 最后一次实际转换是从 0xFFE 到 0xFFF 的转换。理想情况下，当模拟输入等于 VREF+ – 0.5 LSB 时，应存在从 0xFFE 到 0xFFF 的转换。因此对于 VREF+= 3.3 V，最后一次理想转换应发生 在 3.299597 V 处。 如果 ADC 提供 VAIN < VREF+ – 0.5 LSB 的 0xFFF 读数，将获得负增益误差。

**示例**

按以下公式计算增益误差： EG = 最后一次实际转换 – 理想转换

如果 VREF+ = 3.3 V 且 VAIN = 3.298435 V 时生成从 0xFFE 到 0xFFF 的转换，

则： EG = 3.298435 V – 3.299597 V EG = –1162 µV

EG = （–1162 µV / 805.6 V）

LSB = –1.44 LSB

如果 VAIN 等于 VREF + 时没有得到满量程读数（0xFFF），则增益误差为正。

这意味着电压大于 VREF + 将导致最后一次转换。当图 10 显示负增益误差时， 图 9 显示正增益误差。

![](https://pic2.zhimg.com/v2-5e4ed66cb9cd6570e9822fcf2a43010d_r.jpg)![](https://pic4.zhimg.com/v2-30f01ca63bff1e8d65b44c7cb5e83523_r.jpg)

**微分线性误差**

微分线性误差（DLE）为实际步进和理想步进之间的最大偏离。这里的 “理想情况” 不是 指理想传输曲线，而是指 ADC 分辨率。在图 11 中，用 ED 表示 DLE。

ED = 实际步宽 – 1 LSB

理想情况下，1 LSB 的模拟输入电压变化量应导致数字代码变化。如果需要大于 1 LSB 的模拟 输入电压才能导致数字代码变化，将观察到微分线性误差。因此，DLE 对应于从一个数字代 码变为下一个数字代码所需的最大额外电压。 DLE 也称为微分非线性（DLE）误差。

**示例**

给定数字输出应对应于模拟输入范围。理想情况下，步宽应为 1 LSB。我们假设 1.9998 V 至 2.0014 V 模拟输入电压范围内的数字输出相同，则步宽为：

2.0014 V – 1.9998 V = 1.6 mV。

因此，ED 等于较高（2.0014 V）和较低（1.9998 V）模拟电压之间的电压差减去 1 LSB 所对 应的电压。

![](https://pic1.zhimg.com/v2-01903fc677e9c152647faacb27127b70_r.jpg)

如果 VREF+ = 3.3 V，

则 1.9998 V（0x9B1）的模拟输入可提供介于 0x9B0 和 0x9B2 之间的结果。

同样地，2.0014 V（0x9B3）的输入可提供介于 0x9B2 和 0x9B4 之间的结果。

因此，0x9B2 步进所对应的总电压变化量为： 0x9B3 – 0x9B1，

即 2.0014 V – 1.9998 V = 1.6 mV （1660 µV）

ED = 1660 µV – 805.6 µV

ED = 854.4 µV

ED = （854.4 µV/805.6 µV）

LSB ED = 1.06 LSB 假设当步宽小于 1 LSB 时，电压高于 2.0014 V 不会导致 0x9B2 数字代码，则 ED 为负。

ADC 环境导致的误差
-----------

### 参考电压噪声

由于 ADC 输出为模拟信号电压与参考电压之比，因此模拟参考上的任何噪声都会导致转换后数字值的变化。

在某些封装中，VDDA 模拟电源被用作参考电压（VREF+），因此 VDDA 电源的质量会影响 ADC 误差。

例如，当模拟参考为 3.3 V（VREF+ = VDDA）且信号输入为 1 V 时，转换后的结果为： （1/3.3）× 4095 = 0x4D9 但是，当模拟参考中的峰间波动为 40 mV 时，

转换值变为： （1/3.34）× 4095 = 0x4CA（VREF + 在其峰值处）。

误差 = 0x4D9 – 0x4CA = 15 LSB SMPS（开关模式电源）通常内置快速切换功率晶体管。这会在输出中产生高频噪声。此切换噪声介于 15 kHz 至 1MHz 之间。

### 参考电压 / 电源调节

电源调节对于 ADC 精度十分重要，因为转换结果是模拟输入电压与 VREF + 值之比。 当连接到 VDDA 或 VREF + 时，如果这些输入上的负载及其输出阻抗导致电源输出下降，将在转换结果中产生误差。

![](https://pic4.zhimg.com/v2-7e7ed3c905076a74094f46b77a0a7a5b_r.jpg)

如果参考电压变化，数字结果也将发生变化。 例如： 如果所用电源的参考电压为 3.3 V 且 VAIN = 1 V，则数字输出为：

![](https://pic2.zhimg.com/v2-27632bc022c2eca17082ade0b050e5a5_r.jpg)

如果电源提供的电压等于 3.292 V（在其输出连接到 VREF + 后），则：

![](https://pic1.zhimg.com/v2-8b6d071fecfff78938741ac00668593c_r.jpg)

压降产生的误差为：0x4DC – 0x4D9 = 3 LSB。

### 最大输入信号幅度的 ADC 动态范围匹配不佳

为获得最高 ADC 转换精度，ADC 动态范围必须与待转换信号的最大幅度相匹配。我们假设待转换信号在 0 V 与 2.5 V 之间变化，并且 VREF + 等于 3.3 V。ADC 转换的最大信号值为 3102 （2.5 V），如图 14 所示。在本例中，有 993 个未使用转换（4095 – 3102 = 993）。这意味着转换后信号精度下降。 请参见后面的节：将 ADC 动态范围与最大信号幅度进行匹配。

![](https://pic3.zhimg.com/v2-51ef7d27c8106c0818dc5a4307672a8e_r.jpg)

### 模拟信号源电阻的影响

在源和引脚之间的模拟信号源的阻抗或串联电阻（RAIN），可能会因为流入引脚的电流而导致其上的电压降。通过电阻为 RADC 的开关控制内部采样电容（CADC）的充电。 添加了源电阻（RADC）后，保持电容充满电所需的时间延长。图 15 所示为模拟信号源电阻的影响。

CADC 的有效充电受 RADC+ RAIN 控制，因此，充电时间常量为 tc =（RADC+RAIN）× CADC。如果采样时间短于通过 RADC + RAIN 将 CADC 充满电所需的时间（ts < tc），则 ADC 转换的数字值小于实际值。

![](https://pic4.zhimg.com/v2-b265ac4983dd7afa013fb192c7491fdb_r.jpg)

### 温度影响

温度对 ADC 精度有重要影响。它主要产生两种重要误差：偏移误差漂移和增益误差漂移。 些误差可以在微控制器固件中得到补偿。在后面会分享补偿方法。

### I/O 引脚串扰

由于 I/O 之间的电容耦合，切换 I/O 可能会在 ADC 的模拟输入中产生一些噪声。彼此距离很 近或交叉的 PCB 走线可能会产生串扰。 内部切换数字信号和 I/O 会产生高频噪声。由于电流浪涌，切换高灌电流 I/O 可能导致电源 电压小幅下降。PCB 上与模拟输入走线交叉的数字走线可能影响模拟信号（参见图 18）。

![](https://pic1.zhimg.com/v2-c05fd203eac5021d0dff35538216cf84_r.jpg)

如何得到最佳 ADC 精度
-------------

### 参考电压 / 电源噪声最小化 - 供电侧

就噪声而言，线性稳压器的输出质量更佳。电源必须经过降压、整流和滤波，然后送到线性稳压器。强烈建议将滤波电容连接到整流器输出。请参考所用线性稳压器的数据手册。 如果使用开关电源，建议使用线性稳压器在后级。 建议在电源线和地线之间连接具有优良高频特性的电容。也就是说，应在靠近电源的位置放置一个 0.1 µF 和一个 1 至 10 µF 的电容。 这些电容允许 交流 信号通过它们。小值电容过滤高频噪声，高值电容过滤低频噪声。陶瓷电容通常为小值电容 （1 pF 至 0.1 µF），并具有较小的额定电压 （16 V 至 50 V）。建议将它们安装在靠近电源 （VDD 和 VSS）和模拟供电 （VDDA 和 VSSA）引脚的位置。它们将过滤 PCB 走线产生的噪声。小电容可快速响应电流浪涌并快速放电，满足快速电流要求。 钽电容还可以与陶瓷电容一起使用。要过滤低频噪声，您可以使用高值电容 （10 µF 至 100 µF），通常为电解电容。建议将它们安装在电源附近。

要过滤高频噪声，可使用与电源串联的铁氧体电感器。由于线的串行电阻极低，此解决方案 导致的 DC 损失极低（可忽略不计），除非电流很大。但是，高频时的阻抗较高。

### 参考电压 / 电源噪声最小化 - STM32 微控制器端

在大多数 STM32 微控制器中，VDD 和 VSS 引脚的安装位置很接近。因此是 VREF + 和 VSSA 引脚。 因此，可以在非常近的位置通过极短的引线将电容连接到微控制器。对于多个 VDD 和 VSS 引 脚，应使用单独的去耦电容。 VDDA 引脚必须连接到两个外部去耦电容 （10 nF 陶瓷电容 +1 µF 钽电容或陶瓷电容）。关于去耦示例，请参见图 20 和图 21。 对于 100/144 引脚封装中提供的 STM32 微控制器，可通过在 VREF + 上连接单独的外部 ADC 参考电压输入来改善低压输入的精度。VREF + 上的电压范围可以是 2.4 V 至 VDDA。若在 VREF + 上施加单独的外部参考电压，则必须将一个 10 nF 和一个 1 µF 电容连接到此 引脚。任何情况下，VREF + 都必须介于 2.4 V 和 VDDA 之间。

![](https://pic1.zhimg.com/v2-2cbc46cff32390f6392ceddf1d9fa26c_r.jpg)![](https://pic2.zhimg.com/v2-1f579b905ee1c25b91baadf60d6aa3fd_r.jpg)

### 参考电压 / 电源调节

电源应具有正常线和负载调节，因为 ADC 使用 VREF + 或 VDDA 作为模拟参考，并且数字值是模 拟输入信号与该电压参考值之比。因此，VREF + 在不同负载时必须保持稳定。 每当通过开启电路的某部分增加负载时，电流的增大不得导致电压下降。如果电压在较大电流范围内保持稳定，表明电源具有良好的负载调节能力。 例如，对于 LD1086D2M33 调压器，当 VIN 在 2.8 V 至 16.5 V（当 Iload = 10 mA 时）之间变化时，线性调节值通常为 0.035%，而当 Iload 在 0 至 1.5 A 之间变化时，负载调节值为 0.2% 。 线性调节值越低，调节效果越佳。同样，负载调节值越低，电压输出的调节效果和稳定性越佳。

### 模拟输入信号噪声消除 - 平均

平均是一个简单的技巧，即通过软件对模拟输入多次采样，取所有结果的均值。当模拟电压不频繁变化时，此技巧有助于消除模拟输入上的噪声。 必须对全部对应于相同模拟输入电压的多个读数进行平均。在执行转换的时间段内，确保模拟输入维持相同电压，否则会将对应于不同模拟输入的数字值相加，从而产生误差。 在 STM32L0 和 STM32L4 微控制器中，ADC 硬件过采样功能可用于执行平均。此功能只负责将给定数量的 ADC 原始样本合计到一个最终样本中。然后，可以将此最终样本向右移位，从而 减少多个 ADC 样本累计所产生的位宽。所有这些操作（累计和向右移位）均由硬件执行。 STM32L0 和 STM32L4 微控制器支持不超过 256 个输入样本的硬件过采样。

### 模拟输入信号噪声消除 - 添加外部滤波器

添加外部 RC 滤波器以消除高频。无需使用昂贵的滤波器来处理频率分量高于所涉频率范围的信号。这种情况下，截止频率 fC 刚好高于所涉频率范围的相对简单的低通滤波器将足以限制噪声和混叠。使用与所涉最高频率相同的采样率足以，通常为 fC 的 2 至 5 倍。

### 添加白噪声或三角波扫描来改善分辨率

此方法结合了硬件和软件技术来提高精度。从软件的角度来看，此方法使用平均法（过采样），而从硬件的角度来看，它使用信号修改 / 扩展 / 抖动。 当输入信号含有较多噪声（必须有一些信号变化才能计算平均值）并要求获得信号的平均值时，可以使用平均法。当输入信号电压十分稳定且无噪声时，会出现问题。这种情况下，在测量输入信号时，每个数据样本是一样的。这是因为输入信号电平介于两个 ADC 字级之间 （例如 0x14A 和 0x14B 之间）。因此，不能更精确地确定输入电压值（例如，当值接近 0x14A 或接近 0x14B 电平时）。 解决办法是向输入信号中加入噪声或一些信号变化（信号均匀分布，例如三角波扫描），将其电平推过 1 位 ADC 电平（以使信号电平变为低于 0x14A 和高于 0x14B 电平）。这会导致 ADC 结果变化。对不同 ADC 结果应用软件平均法可得到原始输入信号的平均值。STM32L0 和 STM32L4 微控制器具有硬件过采样功能，可用于替代软件过采样。 例如，可使用三角波发生器来实现此方法，将 RC 耦合到输入信号（白噪声的生成更加复杂）。必须注意的是，不要修改原始输入信号的平均值（因此，必须使用电容耦合）。 准三角波源的最简单实现方法是由图 22 上的 STM32 微控制器直接生成。

![](https://pic4.zhimg.com/v2-9ca368511130f5dc7623da7cb4db45f3_r.jpg)

### 将 ADC 动态范围与最大信号幅度进行匹配

此方法通过适当选择参考电压或使用前置放大器级以获得最大可能分辨率来提高精度。

在待测量信号的预期范围内选择参考电压。如果测量的信号具有偏移，则参考电压也应具有类似偏移。如果测量的信号具有已定义的最大幅度，则参考电压也应具有类似的最大值。通 过将此参考电压与测量信号范围进行匹配，可以得到使用完整 ADC 输出范围时的最大可能分 辨率。 在 100 和 144 引脚封装提供的 STM32 微控制器中，ADC 参考电压被连接到应接地的外部 VREF+ 和 VREF - 引脚。这样一来，可以将参考电压与测量信号范围进行匹配。 例如，如果被测信号在 0 V 和 2.5 V 之间变化，建议选择 2.5 V 的 VREF+，可以像 LM235 一样使用参考电压。图 23 描述了这些条件。

![](https://pic3.zhimg.com/v2-06089faacb53d6e4cb914978c0830e2e_r.jpg)

### 使用前置放大器

如果测量信号过小（相比于 ADC 范围），则外部前置放大器可能有用。任何 STM32 封装都可 实现此方法，特别是没有 VREF + 输入的封装。 例如，如果被测信号在 0 V 至 1 V 之间变化并将 VDDA 设置为 3 V，则可以放大信号，以使其正负峰间幅值近似于 VDDA 值。然后，增益等于 3（参见图 24 查看示例）。

此放大器可针对 ADC 范围调整输入信号范围。它还可以在输入信号和 ADC 输入之间插入偏移。在设计前置放大器时，必须注意不要产生额外的误差（例如额外的偏移、放大器增益稳 定性或线性、频率响应）。

![](https://pic4.zhimg.com/v2-671246e03179ab8199e271f5d6c46cef_r.jpg)

### 温度影响补偿

一种方法是完整描述偏移和增益漂移特性，并在存储器中提供查询表，以便根据温度变化修 正测量值。此校准方法需要额外的成本和时间。 第二种方法包括使用内部温度传感器和 ADC 看门狗，以在温度变化达到给定值时重新校准 ADC。

### I/O 引脚串扰最小化

通过让接地走线与之交叉来屏蔽模拟信号，可以减少串扰产生的噪声。图 27 显示了信号间的推荐接地。

![](https://pic4.zhimg.com/v2-5e384c2d909335a7ada60ff7ab85ab17_r.jpg)

### 将模拟和数字布局分开

建立隔离 PCB 上的模拟和数字电路（参见图 29）。这样还可以避免走线彼此交叉。由于会发生耦合，传输数字信号的走线可能在模拟信号中产生高频噪声。 快速切换会导致数字信号产生高频噪声。 通过 PCB 基底（玻璃、陶瓷或塑料）提供的介电隔离金属连接（走线）形成的电容性耦合。 建议使用不同的板提供模拟和数字接地。如果有许多模拟电路，建议使用模拟接地板。模拟接地必须位于模拟电路下方.

![](https://pic1.zhimg.com/v2-d9d5fb9541b807b44b345ae54517f160_r.jpg)